# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 7: "–†–∞–¥–∏—Å—Ç" (WebSockets)

**–°—Ç–µ–∫:** `aiohttp` (–ª—É—á—à–∏–π –≤—ã–±–æ—Ä, —Ç–∞–∫ –∫–∞–∫ —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∏ HTTP, –∏ WS –∑–∞–ø—Ä–æ—Å—ã –≤ –æ–¥–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏) –∏–ª–∏ `websockets`.
**–°—É—Ç—å:** –ú—ã –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º "–ö–∞–∫ –¥–µ–ª–∞?". –ú—ã –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ "—Ç—Ä—É–±–µ" –∏ —Å–ª—É—à–∞–µ–º –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö.
**–ì–ª–∞–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å:** –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–≤–µ—Ç—Å—è. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –º–æ—Ä–≥–∞–µ—Ç. –¢–≤–æ–π —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å **–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è (Reconnect)** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

**–ì–¥–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å:** –ë–∏—Ä–∂–∏ (Binance, Bybit), –±—É–∫–º–µ–∫–µ—Ä—Å–∫–∏–µ –∫–æ–Ω—Ç–æ—Ä—ã (Live-—Å—Ç–∞–≤–∫–∏), –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä—ã, —á–∞—Ç—ã.

```python
import asyncio
import aiohttp
import json
import logging
from typing import Dict

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ä–∞–∑—Ä—ã–≤—ã —Å–≤—è–∑–∏
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger("WSRadio")

# --- 1. CONFIG ---
# –ü—Ä–∏–º–µ—Ä –ø—É–±–ª–∏—á–Ω–æ–≥–æ –≤–µ–±—Å–æ–∫–µ—Ç–∞ Binance (–¢–æ—Ä–≥–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ BTC)
WS_URL = "wss://stream.binance.com:9443/ws/btcusdt@trade"

# –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å JSON, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ
# Binance –ø–æ–∑–≤–æ–ª—è–µ—Ç —á–µ—Ä–µ–∑ URL, –Ω–æ –¥—Ä—É–≥–∏–µ —Ç—Ä–µ–±—É—é—Ç 'subscribe' message.
SUBSCRIPTION_PAYLOAD = {
    "method": "SUBSCRIBE",
    "params": ["btcusdt@trade"],
    "id": 1
}

# --- 2. ARCHITECTURE CLASS ---
class WebSocketMonitor:
    def __init__(self, url: str):
        self.url = url
        self.session = None
        self.ws = None
        self.keep_running = True

    async def connect(self):
        """–ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –∂–∏–∑–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"""
        self.session = aiohttp.ClientSession()

        while self.keep_running:
            try:
                logger.info(f"üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ {self.url}...")

                async with self.session.ws_connect(self.url) as ws:
                    self.ws = ws
                    logger.info("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")

                    # 1. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è - —à–ª–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
                    # await ws.send_json(SUBSCRIPTION_PAYLOAD)

                    # 2. –°–ª—É—à–∞–µ–º —ç—Ñ–∏—Ä (–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª, –ø–æ–∫–∞ —Å–æ–∫–µ—Ç –æ—Ç–∫—Ä—ã—Ç)
                    async for msg in ws:
                        if msg.type == aiohttp.WSMsgType.TEXT:
                            await self.process_message(msg.data)
                        elif msg.type == aiohttp.WSMsgType.ERROR:
                            logger.error("üí• –û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞!")
                            break

                    logger.warning("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä—ã–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.")

            except aiohttp.ClientError as e:
                logger.error(f"üíÄ –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
            except Exception as e:
                logger.error(f"üíÄ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")

            # --- RECONNECT LOGIC ---
            # –ï—Å–ª–∏ –º—ã –≤—ã–ª–µ—Ç–µ–ª–∏ –∏–∑ —Ü–∏–∫–ª–∞ async for, –∑–Ω–∞—á–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ.
            # –ñ–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞.
            logger.info("‚è≥ –†–µ–∫–æ–Ω–Ω–µ–∫—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
            await asyncio.sleep(5)

    async def process_message(self, raw_data: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)"""
        try:
            data = json.loads(raw_data)

            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∏–Ω–≥–∏/–ø–æ–Ω–≥–∏ –∏–ª–∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if "e" not in data:
                return # –≠—Ç–æ –Ω–µ —Å–¥–µ–ª–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

            # –ü—Ä–∏–º–µ—Ä –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–¥–µ–ª–∫–∏ Binance
            trade = {
                "price": float(data['p']),
                "qty": float(data['q']),
                "time": data['T']
            }

            # –¢–£–¢ –ü–ò–®–ï–ú –í –ë–î –ò–õ–ò –û–ß–ï–†–ï–î–¨
            print(f"üí∞ –°–¥–µ–ª–∫–∞: ${trade['price']} (–û–±—ä–µ–º: {trade['qty']})")

        except json.JSONDecodeError:
            pass # –ë—ã–≤–∞–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –º—É—Å–æ—Ä

    async def stop(self):
        """–ê–∫–∫—É—Ä–∞—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ"""
        self.keep_running = False
        if self.ws:
            await self.ws.close()
        if self.session:
            await self.session.close()
        logger.info("üõë –ú–æ–Ω–∏—Ç–æ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")

# --- 3. ENTRY POINT ---
async def main():
    monitor = WebSocketMonitor(WS_URL)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä –≤ —Ñ–æ–Ω–µ
    task = asyncio.create_task(monitor.connect())

    try:
        # –ò–º–∏—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø—É—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å)
        await asyncio.sleep(3600)
    except asyncio.CancelledError:
        pass
    finally:
        await monitor.stop()
        await task

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        # –ß—Ç–æ–±—ã Ctrl+C –Ω–µ –≤—ã–ø–ª–µ–≤—ã–≤–∞–ª —Å—Ç—Ä–∞—à–Ω—ã–µ —Ç—Ä–µ–π—Å–±–µ–∫–∏
        pass

```

**–ö—É–¥–∞ —Å–º–æ—Ç—Ä–µ—Ç—å:**

1. **`while self.keep_running`**: –≠—Ç–æ –±–µ—Å—Å–º–µ—Ä—Ç–∏–µ —Ç–≤–æ–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞. –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–ø–∞–¥–µ—Ç –Ω–∞ —á–∞—Å, —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –¥–æ–ª–±–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å–≤—è–∑—å –Ω–µ –≤–µ—Ä–Ω–µ—Ç—Å—è.
2. **`async for msg in ws`**: –≠—Ç–æ —Å–∞–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á—Ç–µ–Ω–∏—è. –û–Ω –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫, –ø–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.
3. **`SUBSCRIPTION_PAYLOAD`**: –ß–∞—Å—Ç–æ –≤–µ–±—Å–æ–∫–µ—Ç–∞–º –Ω—É–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å "–ü—Ä–∏–≤–µ—Ç, —è —Ö–æ—á—É –¥–∞–Ω–Ω—ã–µ –ø–æ –º–∞—Ç—á—É ID 123". –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ws.send_json()` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–æ–Ω–Ω–µ–∫—Ç–∞.
4. **Heartbeat (–ü–∏–Ω–≥):** `aiohttp` –æ–±—ã—á–Ω–æ —Å–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∏–Ω–≥–∏ (Ping/Pong frames). –ù–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ API —Ç—Ä–µ–±—É—é—Ç —Å–ª–∞—Ç—å `{ "type": "ping" }` –≤—Ä—É—á–Ω—É—é —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥. –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–≤–µ—Ç—Å—è —Ä–æ–≤–Ω–æ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É ‚Äî –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–¥–∞—á—É (`asyncio.create_task`), –∫–æ—Ç–æ—Ä–∞—è —à–ª–µ—Ç –ø–∏–Ω–≥–∏.