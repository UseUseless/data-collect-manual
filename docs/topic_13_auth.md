# –¢–µ–º–∞ 13: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –°–µ—Å—Å–∏–∏: –ö–∞–∫ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Cookies –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –∂–∏–≤–æ–π?

–ù–æ–≤–∏—á–∫–∏ –¥—É–º–∞—é—Ç —Ç–∞–∫: *"–ß—Ç–æ–±—ã —Å–ø–∞—Ä—Å–∏—Ç—å –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, —è –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ"*.
**–≠—Ç–æ –±–∞–Ω.** –°–µ—Ä–≤–µ—Ä —É–≤–∏–¥–∏—Ç, —á—Ç–æ —Ç—ã "–≤—Ö–æ–¥–∏—à—å –≤ –¥–≤–µ—Ä—å" 100 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É. –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –ª—é–¥–∏ —Ç–∞–∫ –Ω–µ –¥–µ–ª–∞—é—Ç.

–í –≤–µ–±–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ **–ù–æ—á–Ω–æ–≥–æ –ö–ª—É–±–∞**:

1. –¢—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å –ø–∞—Å–ø–æ—Ä—Ç —Ñ–µ–π—Å-–∫–æ–Ω—Ç—Ä–æ–ª—é (–õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å).
2. –¢–µ–±–µ —Å—Ç–∞–≤—è—Ç –ø–µ—á–∞—Ç—å –Ω–∞ —Ä—É–∫—É (Cookie / Token).
3. –í –±–∞—Ä–µ —Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å **–ø–µ—á–∞—Ç—å**, –∞ –Ω–µ –ø–∞—Å–ø–æ—Ä—Ç.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–µ—á–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ö—Ä–∞–Ω–∏—Ç—å –µ—ë, –ø–æ–∫–∞ –Ω–µ —Å–º–æ–µ—Ç—Å—è.

---

### 1. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: –°–µ—Å—Å–∏—è (`Session` / `Client`)

–í `requests` –∏ `httpx` –µ—Å—Ç—å –ø–æ–Ω—è—Ç–∏–µ **–°–µ—Å—Å–∏–∏**.
–≠—Ç–æ –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç "–ø–∞–º—è—Ç—å". –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª Cookies –≤ –ø–µ—Ä–≤–æ–º –æ—Ç–≤–µ—Ç–µ, –°–µ—Å—Å–∏—è –∑–∞–ø–æ–º–Ω–∏—Ç –∏—Ö –∏ —Å–∞–º–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –≤–æ –≤—Ç–æ—Ä–æ–π, —Ç—Ä–µ—Ç–∏–π –∏ –¥–µ—Å—è—Ç—ã–π –∑–∞–ø—Ä–æ—Å.

- **–ë–µ–∑ —Å–µ—Å—Å–∏–∏ (–ü–ª–æ—Ö–æ):**
    
    ```python
    httpx.get(url) # –ó–∞–ø—Ä–æ—Å —É–ª–µ—Ç–µ–ª, –∫—É–∫–∏ –ø—Ä–∏—à–ª–∏ –∏... –ø–æ—Ç–µ—Ä—è–ª–∏—Å—å.
    httpx.get(url) # –°–µ—Ä–≤–µ—Ä —Å–Ω–æ–≤–∞ —Å—á–∏—Ç–∞–µ—Ç —Ç–µ–±—è —á—É–∂–∞–∫–æ–º.
    
    ```
    
- **–° —Å–µ—Å—Å–∏–µ–π (–•–æ—Ä–æ—à–æ):**
    
    ```python
    client = httpx.Client()
    client.post(login_url, data={...}) # –ö—É–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤–Ω—É—Ç—Ä–∏ client
    client.get(profile_url) # –ö—É–∫–∏ –ø–æ–ª–µ—Ç–µ–ª–∏ —Å–∞–º–∏. –°–µ—Ä–≤–µ—Ä —É–∑–Ω–∞–ª —Ç–µ–±—è.
    
    ```
    

---

### 2. –ì–ª–∞–≤–Ω–∞—è –õ–æ–≤—É—à–∫–∞: CSRF Token

–¢—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å, –Ω–æ –ø–æ–ª—É—á–∞–µ—à—å 403. –ü–æ—á–µ–º—É?
–ü–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—Ö–æ–¥–∞ –±—ã–ª —Å–∫—Ä—ã—Ç—ã–π –∫–æ–¥ (CSRF Token), –∫–æ—Ç–æ—Ä—ã–π —Å–µ—Ä–≤–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –ª–∏—á–Ω–æ –¥–ª—è —Ç–µ–±—è.

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥–∞:**

1. **GET –∑–∞–ø—Ä–æ—Å** –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞.
2. –ü–∞—Ä—Å–∏–º HTML, –∏—â–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ: `<input type="hidden" name="csrf_token" value="a1b2c3...">`.
3. **POST –∑–∞–ø—Ä–æ—Å** —Å –ª–æ–≥–∏–Ω–æ–º, –ø–∞—Ä–æ–ª–µ–º –ò –≠–¢–ò–ú –¢–û–ö–ï–ù–û–ú.

---

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "–õ–∏—Ü–∞" (Persisting Cookies)

–ü–∞—Ä—Å–µ—Ä —É–ø–∞–ª. –¢—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—à—å –µ–≥–æ. –û–Ω —Å–Ω–æ–≤–∞ –ª–µ–∑–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è.
–≠—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ.
–°–µ–Ω—å–æ—Ä –¥–µ–ª–∞–µ—Ç —Ç–∞–∫: **–ó–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è -> –°–æ—Ö—Ä–∞–Ω–∏–ª –∫—É–∫–∏ –≤ —Ñ–∞–π–ª. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ -> –ó–∞–≥—Ä—É–∑–∏–ª –∫—É–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞.**

---

### üë®‚Äçüíª –ö–û–î: –ë–æ–µ–≤–æ–π –ö–ª–∞—Å—Å –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–ù–∞–ø–∏—à–µ–º –Ω–∞ `httpx`. –≠—Ç–æ—Ç –∫–æ–¥ —É–º–µ–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è, –æ–±—Ö–æ–¥–∏—Ç—å CSRF –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Å—Å–∏—é.

```python
import httpx
import json
import os
from bs4 import BeautifulSoup

class AuthSession:
    def __init__(self, cookies_file="cookies.json"):
        self.client = httpx.Client(http2=True)
        self.client.headers.update({
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        })
        self.cookies_file = cookies_file

    def load_cookies(self):
        """–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—á–∞—Ç—å –∏–∑ —Ñ–∞–π–ª–∞"""
        if os.path.exists(self.cookies_file):
            with open(self.cookies_file, 'r') as f:
                cookies = json.load(f)
                # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É–∫–∏ –≤ –∫–ª–∏–µ–Ω—Ç
                for name, value in cookies.items():
                    self.client.cookies.set(name, value)
            return True
        return False

    def save_cookies(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—á–∞—Ç—å –Ω–∞ –¥–∏—Å–∫"""
        cookies_dict = {c.name: c.value for c in self.client.cookies}
        with open(self.cookies_file, 'w') as f:
            json.dump(cookies_dict, f)

    def login(self, url, username, password):
        # 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∂–∏–≤–∞ –ª–∏ —Å—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è
        if self.load_cookies():
            # –î–µ–ª–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –ø—Ä–æ—Ñ–∏–ª—å
            resp = self.client.get("<https://site.com/profile>")
            if resp.status_code == 200 and username in resp.text:
                print("‚úÖ –°—Ç–∞—Ä—ã–µ –∫—É–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç! –õ–æ–≥–∏–Ω –Ω–µ –Ω—É–∂–µ–Ω.")
                return True
            else:
                print("‚ö†Ô∏è –ö—É–∫–∏ –ø—Ä–æ—Ç—É—Ö–ª–∏. –õ–æ–≥–∏–Ω–∏–º—Å—è –∑–∞–Ω–æ–≤–æ...")

        # 2. GET –∑–∞–ø—Ä–æ—Å –∑–∞ CSRF —Ç–æ–∫–µ–Ω–æ–º
        login_page = self.client.get(url)
        soup = BeautifulSoup(login_page.text, "lxml")

        # –ò—â–µ–º —Å–∫—Ä—ã—Ç—ã–π —Ç–æ–∫–µ–Ω (–∏–º—è –ø–æ–ª—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∞–π—Ç–∞: csrf, _token, authenticity_token)
        csrf_token = soup.find("input", {"name": "csrf_token"})
        token_value = csrf_token["value"] if csrf_token else None

        # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        payload = {
            "username": username,
            "password": password,
        }
        if token_value:
            payload["csrf_token"] = token_value

        # 4. POST –∑–∞–ø—Ä–æ—Å (–í—Ö–æ–¥–∏–º)
        # –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ self.client!
        resp = self.client.post(url, data=payload)

        if resp.status_code == 200 or resp.status_code == 302:
            print("üéâ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!")
            self.save_cookies() # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –±—É–¥—É—â–µ–µ
            return True
        else:
            print("‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", resp.status_code)
            return False

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
session = AuthSession()
session.login("<https://site.com/login>", "admin", "12345")

# –î–∞–ª—å—à–µ –ø–∞—Ä—Å–∏–º —á–µ—Ä–µ–∑ session.client
response = session.client.get("<https://site.com/secret-data>")

```

---

### 4. –ù—é–∞–Ω—Å: Bearer Token (JWT)

–ù–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö (SPA) –≤–º–µ—Å—Ç–æ –∫—É–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **Token**.
–°–µ—Ä–≤–µ—Ä –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –ª–æ–≥–∏–Ω –ø—Ä–∏—Å—ã–ª–∞–µ—Ç JSON: `{"access_token": "eyJhbG..."}`.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**

1. –°–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –≤ —Ñ–∞–π–ª (–∫–∞–∫ —Å—Ç—Ä–æ–∫—É).
2. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –¥–æ–±–∞–≤–ª—è–π –µ–≥–æ –≤ **–ó–∞–≥–æ–ª–æ–≤–∫–∏**, –∞ –Ω–µ –≤ –∫—É–∫–∏:
    
    ```python
    headers = {
        "Authorization": f"Bearer {saved_token}"
    }
    client.get(url, headers=headers)
    
    ```
    

### üß† –†–µ–∑—é–º–µ –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞:

1. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏–Ω—å—Å—è –≤ —Ü–∏–∫–ª–µ.
2. –ò—Å–ø–æ–ª—å–∑—É–π `httpx.Client()` –∏–ª–∏ `requests.Session()`, —á—Ç–æ–±—ã –¥–µ—Ä–∂–∞—Ç—å —Å—Ç–µ–π—Ç.
3. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –Ω–∞–ª–∏—á–∏–µ **CSRF** —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–∞—Ä–æ–ª—è.
4. –°–æ—Ö—Ä–∞–Ω—è–π –∫—É–∫–∏/—Ç–æ–∫–µ–Ω—ã –≤ —Ñ–∞–π–ª. –¢–≤–æ–π –ø–∞—Ä—Å–µ—Ä –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å "–ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è" —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º.